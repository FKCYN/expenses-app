import { NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { requireAuth } from "@/lib/auth";

export async function POST(request: Request) {
  try {
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á prompt ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI ‡πÉ‡∏´‡πâ‡πÅ‡∏ã‡∏ß‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    const categoryNamesTh: { [key: string]: string } = {
      food: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
      shopping: "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á",
      transport: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
      other: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
    };

    const { title, amount, category } = await request.json();
    const authUser = await requireAuth();

    if (!authUser) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const supabase = await createClient();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    const { data: dailyExpenses } = await supabase
      .from("expenses")
      .select("title, amount, category")
      .eq("user_id", authUser.user_id)
      .gte("created_at", today.toISOString())
      .lt("created_at", tomorrow.toISOString());

    const dailyExpensesText = dailyExpenses
      ?.map(
        (e) =>
          `- ${e.title}: ${e.amount} ‡∏ö‡∏≤‡∏ó (${
            categoryNamesTh[e.category] || e.category
          })`
      )
      .join("\n");

    const apiKey = process.env.GEMINI_API_KEY;

    if (!apiKey) {
      console.error("GEMINI_API_KEY is not set");
      return NextResponse.json({ comment: null }, { status: 200 });
    }

    const categoryTh = categoryNamesTh[category] || category;
    const systemInstructionText = `
     ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏π‡∏ó‡∏≠‡∏î üê∑ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏™‡∏≤‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢" ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ

‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å:
- ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏Ç‡∏µ‡πâ‡πÅ‡∏ã‡∏ß ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á
- ‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
- ‡πÑ‡∏°‡πà‡∏î‡∏∏ ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÄ‡∏ï‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ú‡∏¥‡∏î
- ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÉ‡∏ä‡πâ emoji ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1‚Äì2 ‡∏ï‡∏±‡∏ß)

‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:
‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏™‡∏±‡πâ‡∏ô ‡πÜ 1‚Äì2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà ‚Äú‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‚Äù ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ:
- title: ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
- amount: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)
- category: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á, ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á, ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)

‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô:
${dailyExpensesText || "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"}

‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ö (‡∏Ñ‡∏¥‡∏î‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤):
1. ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∞‡πÑ‡∏£
2. ‡∏°‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô:
   - ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏´‡∏ô‡∏ã‡πâ‡∏≥
   - ‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô/‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÑ‡∏´‡∏°
   - ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤
   - ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏£‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏°
3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î:
   - ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢ ‚Üí ‡∏ä‡∏¥‡∏• ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á
   - ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ã‡πâ‡∏≥ ‚Üí ‡πÅ‡∏ã‡∏ß‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡πÑ‡∏î‡πâ
   - ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞ ‚Üí ‡πÅ‡∏ã‡∏ß‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏ö‡∏ö‡∏´‡πà‡∏ß‡∏á
4. ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô ‚Äú‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‚Äù

‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ã‡∏ß (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå):
- ‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° ‚Üí ‡∏≠‡∏£‡πà‡∏≠‡∏¢ ‡∏ô‡πà‡∏≤‡∏Å‡∏¥‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ã‡∏ß‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
- ‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô/‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏Å‡πâ‡∏ß ‚Üí ‡πÅ‡∏ã‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÅ‡∏ö‡∏ö‡∏´‡πà‡∏ß‡∏á
- ‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Üí ‡πÅ‡∏ã‡∏ß‡∏ß‡πà‡∏≤‡∏ä‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏à‡∏£‡∏¥‡∏á
- ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á ‚Üí ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÑ‡∏õ‡πÑ‡∏´‡∏ô ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡πÑ‡∏´‡∏°
- ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á ‚Üí ‡πÅ‡∏ã‡∏ß‡∏°‡∏∑‡∏≠‡∏•‡∏±‡πà‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
- ‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‚Üí ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏ß‡∏ô‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°

‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πâ‡∏ß‡∏ô
- ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏Å‡∏•‡∏≤‡∏á ‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£

‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:
‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡πà‡∏≤
‚Äú‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏≠‡∏¢‡∏°‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏≠‡∏¢‡∏π‡πà‚Äù

    `;

    const userPrompt = `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${title}, ‡∏£‡∏≤‡∏Ñ‡∏≤: ${amount}, ‡∏´‡∏°‡∏ß‡∏î: ${categoryTh}`;

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          systemInstruction: {
            parts: [{ text: systemInstructionText }],
          },
          contents: [{ parts: [{ text: userPrompt }] }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 600,
          },
        }),
      }
    );

    if (!response.ok) {
      console.error("Gemini API error:", await response.text());
      return NextResponse.json({ comment: null }, { status: 200 });
    }

    const data = await response.json();
    const comment =
      data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;

    return NextResponse.json({ comment }, { status: 200 });
  } catch (error) {
    console.error("AI Teasing API Error:", error);
    return NextResponse.json({ comment: null }, { status: 200 });
  }
}
